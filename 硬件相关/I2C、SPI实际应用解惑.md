## ①I2C/SPI总线为什么是共享资源

### 1. **为什么 I²C/SPI 总线是共享资源？**

在 STM32 或其他 MCU 上，I²C 和 SPI 总线并不是只给一个外设用的，而是**一个总线可以挂载多个设备**。

- **I²C**：主控（STM32）通过两根信号线 `SCL`（时钟）和 `SDA`（数据）控制通信。所有从设备（传感器、存储器、模块）都**并联在同一条总线上**。设备通过**地址**来区分。
- **SPI**：主控（STM32）通过 `SCLK`（时钟）、`MOSI`（主出从入）、`MISO`（主入从出）这几条线与所有从设备通信。每个设备再有自己独立的 **片选信号 CS/SS**，主控通过拉低某个片选引脚决定和哪个从设备通信。

所以：

- **物理上**，I²C/SPI 总线确实是几根线，所有设备引脚都接在一起（共享线）。
- **逻辑上**，通信是独占的：同一时刻，主机只能和一个从机进行有效通信。

------

### 2. **为什么叫“共享资源”？**

在 RTOS 或多任务环境中，如果多个任务同时要用 I²C/SPI 传感器，会出现冲突：

- Task A 还没发完数据，Task B 又开始访问 → 可能产生**总线争用、数据错误**。
- 典型问题：任务同时调用 `I2C_Transmit()`，I²C 状态机被打乱。

因此，必须在软件层面用**互斥锁（Mutex）或信号量**来保证：

- 一个任务在使用 I²C/SPI 的时候，其他任务不能抢。
- 任务 A 用完后释放锁，任务 B 才能开始。

这就是为什么 I²C/SPI 被视为 **共享资源**。

------

## ②

### 1. **MCU 上的 I²C / SPI 外设数量**

- STM32 芯片上通常有 **多个硬件 I²C 外设**（比如 I2C1、I2C2、I2C3...），也有 **多个 SPI 外设**（SPI1、SPI2...）。
- 每个外设可以映射到不同的引脚组（通过 AF 复用功能）。
- 所以**不是只有一根总线**，而是 MCU 上有若干个独立的 I²C/SPI 外设，你可以选择用一个或多个。

### 2. **I²C 设备的选择方式**

I²C 和 SPI 最大的区别就在于 **设备寻址**：

- **SPI**：靠片选信号（CS/SS）区分设备。
  - 例子：OLED 用 `CS1`，Flash 用 `CS2`。
  - MCU 在通信时，把对应设备的 `CS` 拉低，就和这个设备说话。
- **I²C**：靠**设备地址（7位/10位）**区分设备。
  - I²C 总线上所有设备都监听 `SCL` 和 `SDA`。
  - 当主机发起通信时，它会先发一个 **设备地址**。
  - 地址匹配的设备会应答（ACK），其他设备保持沉默。

 也就是说，I²C 不需要片选引脚，靠地址来区分；而 SPI 靠片选引脚。

------

## ③两个设备使用杜邦线无法连接到同一个引脚，需要什么方法

###  1. I²C 的情况

- I²C 是 **真正意义上的总线结构**。
- 一根 `SCL`，一根 `SDA`，所有设备都并联在这两根线上。

#### 连接方法：

- `MCU_SCL` ↔ 所有设备的 `SCL`
- `MCU_SDA` ↔ 所有设备的 `SDA`
- 都需要 **上拉电阻**（通常 4.7kΩ 到 10kΩ），SCL 和 SDA 各一根。

所以 I²C 不用占用额外引脚，杜邦线只要把几根线并在一起就行（可以用面包板或者焊接小排针排线）。

------

###  2. SPI 的情况

- SPI 是 **一主多从** 的方式。
- 共享信号：`SCK`、`MOSI`、`MISO`。
- 独立信号：每个设备需要一个单独的 `CS`（片选）。

#### 连接方法：

- `MCU_SCK` ↔ 所有设备的 `SCK`
- `MCU_MOSI` ↔ 所有设备的 `MOSI`
- `MCU_MISO` ↔ 所有设备的 `MISO`
- `MCU_CS1` ↔ 设备1 的 `CS`
- `MCU_CS2` ↔ 设备2 的 `CS`
- …以此类推

 因此，SPI 在多设备时会多占用几根 `CS` 引脚。

------

### 3. 物理连接方式

如果你手里只有杜邦线，一根引脚只能插一根线，那要“分线”有几种常用方法：

1. #### **面包板**

   - 把 MCU 引脚通过杜邦线接到面包板，其他设备的线也插到同一排，就实现并联。

2. #### **排针+排母**

   - MCU 引脚插到一个排针，再用排母扩展出去，就能接多个设备。

3. #### **专用扩展模块**

   - 例如 I²C 分线板（I2C Hub）、SPI 分线板，可以把一组接口扩展出多个插座，方便接多个模块。

------

### **总结**

- I²C：所有设备并联在 SDA 和 SCL 上（靠地址区分），要加上拉电阻。
- SPI：共享 SCK/MOSI/MISO，每个设备单独一个 CS 引脚。
- 物理上需要 **面包板 / 分线器 / 分线板** 来实现一对多连接，而不是杜邦线硬插。

------

## ④为什么MCU上会出现多个SPI1_MISO

###  为什么会出现多个 SPI1_MISO

- 在 MCU（比如 STM32）中，**一个外设的引脚功能可以复用到多个物理引脚**。
- 比如 STM32F407 的 **SPI1_MISO**，可能既能映射到 **PA6**，也能映射到 **PB4**。
- 但你只能选择其中一个作为 SPI1_MISO 的实际工作引脚，不能同时用。

------

### 为什么要这样设计？

这是为了 **引脚资源灵活性**：

- 不同封装的芯片（LQFP48 / LQFP100 / BGA）管脚数量不同。
- 有的项目可能某些引脚已经被占用，就可以换一个引脚作为 SPI 功能。
- 避免因为一个引脚冲突就无法使用整个外设。

------

### 你要做的选择

在 STM32CubeMX 或手工配置时：

1. 选择 SPI1 外设 → 会看到多个可选 MISO、MOSI、SCK。
2. 选定一个没有冲突的引脚。
3. 配置 GPIO 的 **复用功能 (AF)** 为 SPI。

------

###  **总结**

- “多个 SPI1_MISO” 是因为 **同一个外设信号可以复用到多个物理引脚**。
- 实际使用时 **只能选一个**，否则总线会冲突。
- 这是 MCU 厂商为了引脚资源灵活性而设计的。